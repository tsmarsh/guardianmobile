
var db;var initialiseDB=function(){window.console.log("Initialising db");db.transaction(function(tx){tx.executeSql("SELECT COUNT(*) FROM content",[],function(_2){window.console.log("Database already initialised");},function(tx,_4){tx.executeSql("CREATE TABLE content (guid TEXT UNIQUE, feed TEXT, title TEXT, date TEXT, sysdate REAL, description TEXT, creator TEXT)",[],function(_5){window.console.log("Created content table");});tx.executeSql("CREATE TABLE thumbnails (guid TEXT UNIQUE, src TEXT, title TEXT)",[],function(_6){window.console.log("Created thumbnail table");});});});};var loadFeed=function(_7){window.console.log("Loading feed");jQuery.getJSON(_7+"/json",function(_8){storeFeed(_8,_7);});};var storeFeed=function(_9,_a){window.console.log("Storing feed");db.transaction(function(tx){var _c=false;jQuery.each(_9.content,function(){tx.executeSql("INSERT OR REPLACE INTO content(guid, feed, title, date, sysdate, description, creator) VALUES(?,?,?,?,?,?,?)",[this.guid,_a,this.title,this.date,this.sysdate,this.description,this.creator],function(tx,_e){if(_e.rowsAffected>0){_c=true;if(this.thumbnail){tx.executeSql("INSERT OR REPLACE INTO thumbnails(guid, src, title) VALUES(?,?,?)",[this.guid,this.thumbnail.url,this.thumbnail.alttext]);}}});});if(_c){getLeaders(feedUrl);getLatest(feedUrl);}});};var getLeaders=function(_f){window.console.log("Getting leaders from db");db.transaction(function(tx){tx.executeSql("SELECT * FROM content WHERE feed = ? ORDER BY sysdate DESC LIMIT 10",[_f],function(tx,_12){$("ul#leaders").empty();window.console.log("Got leaders: "+_12.rows.length);for(var i=0;i<_12.rows.length;i++){populateLeaders(_12.rows.item(i));}});});};var getLatest=function(_14){window.console.log("Getting latest from db");db.transaction(function(tx){tx.executeSql("SELECT * FROM content WHERE feed = ? ORDER BY sysdate DESC LIMIT 10 OFFSET 10",[_14],function(tx,_17){window.console.log("Got latest: "+_17.rows.length);$("ul#latest").empty();for(var i=0;i<_17.rows.length;i++){populateLatest(_17.rows.item(i));}});});};var populateLatest=function(_19){window.console.log("Populating building li for latest: "+_19.title);$("ul#latest").append($(document.createElement("li")).addClass("content").append($(document.createElement("h2")).text(_19.title).click(function(){alert("Preparing to do something clever with: "+_19.guid);})));};var buildThumbnail=function(_1a){window.console.log("Building thumbnail");db.transaction(function(tx){tx.executeSql("SELECT * FROM thumbnails WHERE guid = ?",[_1a],function(tx,_1d){if(_1d.rows.length>0){var _1e=_1d.rows.item(0);window.console.log("Thumbnail: "+_1e["src"]);window.console.log("trying to append it to:"+"li#"+_1a+" div.content");$("li#"+_1a+" div.content").prepend($(document.createElement("img")).attr("src",_1e["src"]).attr("title",_1e["title"]).attr("class","thumbnail"));}});});};var getStory=function(_1f){window.console.log("Getting story: "+_1f);db.transaction(function(tx){tx.executeSql("SELECT * FROM content WHERE guid = ?",[_1f],function(tx,_22){window.console.log("Building story: "+_1f);$("div#story").html("<h1>STUFF</h1>");});});};var transitionToStory=function(_23){$("div#trail").slideUp("fast");buildStory(_23);};var populateLeaders=function(_24){window.console.log("Populating building li for leader: "+_24.title);var li=$(document.createElement("li")).attr("id",_24.guid).addClass("content").append($(document.createElement("h2")).text(_24.title).click(function(){transitionToStory(_24.guid);}));buildThumbnail(_24.guid);li.append($(document.createElement("div")).addClass("content").html(_24.description));$("ul#leaders").append(li);};var updateTrail=function(_26){getLeaders(_26);getLatest(_26);$("div#trail").slideDown("slow");};var populateTrail=function(_27){$("div#trail").slideUp("slow",function(){updateTrail(_27);});loadFeed(_27);};var activateMenu=function(){$("li.zone").click(function(){populateTrail($(this).attr("name"));});};try{if(window.openDatabase){window.console.log("Opening db");db=openDatabase("GuardianMobile","1.0","Local content cache, for when you're on the move",5000000);initialiseDB();if(!db){alert("Failed to open the database on disk. Probably need to write code that cleans old articles out");}}else{alert("Your phone sucks. Get a real one");}}
catch(err){window.console.log("There was an error: "+err);}